#!/usr/bin/env ruby
#
$:.unshift(File.dirname(__FILE__))
require 'rubygems'
require 'snorby_suite'
require 'optparse'

options = {}

optparse = OptionParser.new do |opts|
  opts.banner = "Alert Daemon (Version #{SnorbySuite::VERSION} )"  
  opts.separator "Usage: #$0 [options]"
  # Optional argument with keyword completion.
  opts.on("--sensor [NAME]", SnorbySuite::SENSORS,
    "Select Sensor (#{SnorbySuite::SENSORS.join(', ')})") do |t|
     options[:sensor] = t
  end
  opts.on_tail( '-h', '--help', 'Display this screen' ) do
    puts opts
    exit
  end
end

#Verrify the options
begin
  raise unless ARGV.size > 0
  optparse.parse!
  
#If options fail display help
rescue
  puts optparse
  exit
end

factory = SnorbySuite::Pcapfactory.new

def pcapfile
  "/tmp/pcapfactory.pcap.#{$$}"
end

loop do

  factory.filename = pcapfile
  puts "Regenerating pcap file '#{factory.filename}' .."
  
  factory.generate
  factory.write_pcaps
  
  puts "Running Snort.."
  `snort -r #{factory.filename} -S U2EXT=#{options[:sensor]} -c #{SnorbySuite::SNORTCONF} -l #{SnorbySuite::UNIFIEDDIR} -q`
  puts "Closing Snort."
  
  sleep(15)
  factory.flush
end


